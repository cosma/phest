checkout:
  post:
    - git submodule sync
    - git submodule update --init

machine:
  timezone:
    UTC
  php:
    version: 5.6.22

dependencies:
  pre:
    - sed -i 's/^;//' /opt/circleci/.phpenv/versions/$(phpenv global)/etc/conf.d/xdebug.ini
    - composer remove ext-phalcon
#    - sh bin/install-phalcon.sh phalcon-v2.0.13
#    - sudo apt-get update
#    - sudo apt-get install php5-dev php5-mysql gcc libpcre3-dev
#    - git clone --depth=1 --branch=v1.2.5  git://github.com/phalcon/cphalcon.git
#    - pwd
#    - export LC_ALL="en_US.UTF-8"
#    - export CFLAGS="-O2 --fvisibility=hidden"
#    - cd cphalcon/build/64bits && sudo phpize && sudo ./configure --enable-phalcon && sudo make && sudo make install
#    #- cd phest/cphalcon/build && sudo ./install
#    - echo 'extension=/home/ubuntu/phest/cphalcon/build/64bits/modules/phalcon.so' | sudo tee -a /opt/circleci/php/$(phpenv global)/etc/php.ini

  post:
      - vendor/bin/install-phalcon.sh phalcon-v2.0.13
      - php -r "echo \Phalcon\Version::get();"
      - composer require ext-phalcon "^2.0"

  cache_directories:
    - vendor
    - ~/cphalcon
    - ~/.composer/cache

test:
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/phpunit
    - vendor/bin/phpunit -c phpunit.xml.dist --coverage-text --log-junit $CIRCLE_TEST_REPORTS/phpunit/junit.xml

