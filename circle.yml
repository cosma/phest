checkout:
  post:
    - git submodule sync
    - git submodule update --init

machine:
  timezone:
    UTC
  php:
    version: 5.6.22

dependencies:
  pre:
    - sed -i 's/^;//' /opt/circleci/.phpenv/versions/$(phpenv global)/etc/conf.d/xdebug.ini
    - sudo apt-get update
    - sudo apt-get install php5-dev php5-mysql gcc libpcre3-dev
    - git clone --depth=1 --branch phalcon-v2.0.13 git://github.com/phalcon/cphalcon.git
    - cd phest/cphalcon/build/64bits && make clean
    - sudo apt-get install --reinstall language-pack-en-base && locale-gen en_US.UTF-8 && dpkg-reconfigure locales
    - phpize ./configure --with-php-config=/usr/local/php/bin/php-config
    - cd phest/cphalcon/build/64bits && make && make install
    - cd phest/cphalcon/build && sudo ./install
    - echo 'extension=/home/ubuntu/phest/cphalcon/build/64bits/modules/phalcon.so' | sudo tee -a /opt/circleci/php/$(phpenv global)/etc/php.ini

  cache_directories:
    - "vendor"

test:
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/phpunit
    - vendor/bin/phpunit -c phpunit.xml.dist --coverage-text --log-junit $CIRCLE_TEST_REPORTS/phpunit/junit.xml

